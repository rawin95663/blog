---
slug: trinh-duyet-render-website-nhu-the-nao
title: TrÃ¬nh duyá»‡t render website nhÆ° tháº¿ nÃ o?
tags: [browser]
---

{/* truncate */}

### Táº¡i sao nÃªn Ä‘á»c bÃ i nÃ y?
* Hiá»ƒu rÃµ hÆ¡n vá» cÃ¡ch trÃ¬nh duyá»‡t render website
* CÃ³ thá»ƒ giÃºp báº¡n giáº£i quyáº¿t má»™t sá»‘ váº¥n Ä‘á» liÃªn quan Ä‘áº¿n hiá»‡u suáº¥t website
* LÃ m mÃ u, loÃ¨ thiÃªn háº¡, thá»ƒ hiá»‡n ta lÃ  ngÆ°á»i hiá»ƒu rÃµ cÆ¡ cháº¿ ngá»n ngÃ nh ğŸ˜


### PhÃ¢n tÃ­ch cÃº phÃ¡p HTML
 Táº¡m bá» qua quÃ¡ trÃ¬nh tá»« khi chÃºng ta nháº­p 1 Ä‘á»‹a chá»‰ url vÃ o thanh tÃ¬m kiáº¿m, chÃºng ta báº¯t Ä‘áº§u phÃ¢n tÃ­ch ká»ƒ tá»« khi browser nháº­n Ä‘Æ°á»£c ná»™i dung HTML.

 Ká»ƒ tá»« khi nháº­n Ä‘Æ°á»£c thÃ´ng tin HTML, trÃ¬nh duyá»‡t sáº½ báº¯t Ä‘áº§u phÃ¢n tÃ­ch cÃº phÃ¡p HTML thÃ nh DOM.

 > The Document Object Model (DOM) is the data representation of the objects that comprise the structure and content of a document on the web.

![Parse HTML](./html-parse.png)

Hiá»ƒu Ä‘Æ¡n giáº£n quÃ¡ trÃ¬nh nÃ y sáº½ phÃ¢n tÃ¡ch HTML document thÃ nh nhá»¯ng Ä‘á»‘i tÆ°á»£ng con lÃ  cÃ¡c tháº», ná»™i dung cá»§a chÃºng. Tá»« nhá»¯ng Ä‘á»‘i tÆ°á»£ng nÃ y, trÃ¬nh duyá»‡t sáº½ xÃ¢y dá»±ng cáº¥u trÃºc cÃ¢y DOM.

### Táº£i external resources

External resources bao gá»“m cÃ¡c file css, js, image, font, ...
QuÃ¡ trÃ¬nh Ä‘á»c vÃ  phÃ¢n tÃ­ch HTML sáº½ Ä‘Æ°á»£c diá»…n ra tuáº§n tá»± tá»« Ä‘áº§u document Ä‘áº¿n cuá»‘i document. Khi gáº·p cÃ¡c tháº» link, script, img, ... trÃ¬nh duyá»‡t sáº½ báº¯t Ä‘áº§u táº£i cÃ¡c file nÃ y.

Äá»‘i vá»›i external resource chÃºng ta cáº§n quan tÃ¢m resource nÃ y áº£nh hÆ°á»Ÿng tháº¿ nÃ o tá»›i quÃ¡ trÃ¬nh hiá»ƒn thá»‹ trang web.
CÃ³ 2 khÃ¡i niá»‡m chÃºng ta cáº§n náº¯m báº¯t Ä‘Æ°á»£c lÃ  "Block parsing" vÃ  "Block rendering"

* Block parsing: trong quÃ¡ trÃ¬nh nÃ y, trÃ¬nh duyá»‡t sáº½ khÃ´ng thá»ƒ tiáº¿p tá»¥c phÃ¢n tÃ­ch cÃº phÃ¡p HTML cho Ä‘áº¿n khi táº£i xong file nÃ y.
* Block rendering: trÃ¬nh duyá»‡t sáº½ khÃ´ng thá»ƒ render trang web cho Ä‘áº¿n khi táº£i xong file nÃ y.

CSS lÃ  block rendering resource, cÃ²n JS lÃ  block parsing resource.

CÃ¹ng suy nghÄ© chÃºt táº¡i sao láº¡i váº­y, vÃ¬ sao trÃ¬nh duyá»‡t khÃ´ng thá»±c hiá»‡n song song mÃ  láº¡i cÃ³ hiá»‡n tÆ°á»£ng blocking táº¡i Ä‘Ã¢y.

#### Parsing block scripts
Äá»‘i vá»›i Javascript. Khi gáº·p tháº» script trÃ¬nh duyá»‡t sáº½ dá»«ng viá»‡c phÃ¢n tÃ­ch HTML, táº£i file js vá» vÃ  thá»±c thi, káº¿t thÃºc quÃ¡ trÃ¬nh má»›i tiáº¿p tá»¥c phÃ¢n tÃ­ch HTML thÃ nh DOM. TrÃ¬nh duyá»‡t cung cáº¥p DOM API cho Javascript Runtime, Ä‘iá»u nÃ y cho phÃ©p JS truy cáº­p vÃ  quáº£n lÃ½ cÃ¡c pháº§n tá»­ cá»§a DOM, náº¿u trÃ¬nh duyá»‡t chÆ°a xÃ¢y dá»±ng xong DOM thÃ¬ Javascript sáº½ khÃ´ng thá»ƒ thao tÃ¡c trÃªn DOM. Náº¿u quÃ¡ trÃ¬nh parsing HTML vÃ  thá»±c thi JS diá»…n ra song song cÃ³ thá»ƒ dáº«n tá»›i hiá»‡n tÆ°á»£ng Race Conditions

> A "race condition" exists when multithreaded (or otherwise parallel) code that would access a shared resource could do so in such a way as to cause unexpected results.

Race conditions lÃ  váº¥n Ä‘á» nhá»©c nhá»‘i, phá»• biáº¿n trong láº­p trÃ¬nh cÅ©ng nhÆ° Ä‘á»i sá»‘ng hÃ ng ngÃ y. Thá»­ tÆ°á»Ÿng tÆ°á»£ng báº¡n rá»§ crush Ä‘i chÆ¡i, nhÆ°ng crush láº¡i Ä‘i chÆ¡i vá»›i tháº±ng khÃ¡c Ä‘Ãºng thá»i Ä‘iá»ƒm Ä‘Ã³ => NghÄ© thÃ´i Ä‘Ã£ tháº¥y "Cayyyyy" ğŸ˜¢

Trong thá»±c táº¿ viá»‡c parse blocking khi js Ä‘Æ°á»£c táº£i lÃ  khÃ´ng cáº§n thiáº¿t náº¿u ta lÃ  chá»§ Ä‘Æ°á»£c tÃ i nguyÃªn. Do Ä‘Ã³ HTML5 cung cáº¥p cho ta 2 thuá»™c tÃ­nh defer vÃ  async Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y.

``` javascript
<script type="text/javascript" src="script.js" defer>
<script type="text/javascript" src="script.js" async>
```

* defer: cho phÃ©p táº£i file js mÃ  khÃ´ng block parsing HTML, thá»±c thi js sau khi DOM Ä‘Æ°á»£c xÃ¢y dá»±ng xong. Nhiá»u file Ä‘Æ°á»£c defer sáº½ thá»±c thi theo thá»© tá»± xuáº¥t hiá»‡n trong HTML.
* async: cho phÃ©p táº£i file js mÃ  khÃ´ng block parsing HTML, thá»±c thi js ngay sau khi táº£i xong. Nhiá»u file Ä‘Æ°á»£c async sáº½ thá»±c thi Ä‘á»“ng thá»i ngay khi file Ä‘Æ°á»£c táº£i.
![External resource](./external-resource.png)

#### Rendering block CSS
Äá»‘i vá»›i HTML chÃºng ta cÃ³ khÃ¡i niá»‡m DOM, Ä‘á»‘i vá»›i CSS chÃºng ta cÅ©ng cÃ³ khÃ¡i niá»‡m CSSOM

> The CSS Object Model (CSSOM) is a map of all CSS selectors and relevant properties for each selector in the form of a tree, with a root node, sibling, descendant, child, and other relationship. The CSSOM is very similar to the Document Object Model (DOM). Both of them are part of the critical rendering path which is a series of steps that must happen to properly render a website. <br/>
> The CSSOM, together with the DOM, to build the render tree, which is in turn used by the browser to layout and paint the web page.

CÃ³ 1 Ä‘iá»ƒm khÃ¡c biá»‡t giá»¯a DOM vÃ  CSSOM lÃ  DOM Ä‘Æ°á»£c xÃ¢y dá»±ng tuáº§n tá»± tá»« trÃªn xuá»‘ng dÆ°á»›i, cÃ²n CSSOM khi khÃ´ng. 
Khi gáº·p external resource CSS file trÃ¬nh duyá»‡t sáº½ thá»±c hiá»‡n táº£i CSS file dÆ°á»›i background mÃ  khÃ´ng block quÃ¡ trÃ¬nh parsing HTML. NhÆ°ng trÃ¬nh duyá»‡t sáº½ khÃ´ng thá»±c hiá»‡n ngay viá»‡c parsing CSS thÃ nh CSSOM má»™t cÃ¡ch tuáº§n tá»±, CSSOM chá»‰ xáº£y ra khi toÃ n bá»™ CSS Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ vÃ  sáºµn sÃ ng. NguyÃªn nhÃ¢n cÃ³ thá»ƒ hiá»ƒu CSS lÃ  ***Cascading*** cÃ³ nghÄ©a lÃ  CSS cÃ³ thá»ƒ bá»‹ ghi Ä‘Ã¨, cháº¯c háº³n báº¡n khÃ´ng muá»‘n tháº¥y style cá»§a trang web nháº£y vÃ  Ä‘Æ°á»£c cáº­p nháº­t liÃªn tá»¥c chá»©. Do Ä‘Ã³ CSSOM chá»‰ Ä‘Æ°á»£c xÃ¢y dá»±ng khi toÃ n bá»™ CSS Ä‘Ã£ Ä‘Æ°á»£c táº£i vá» vÃ  sáºµn sÃ ng. CSSOM tree Ä‘Æ°á»£c hoÃ n thiá»‡n káº¿t há»£p vá»›i DOM tree render trang web cá»§a báº¡n => CSS lÃ  render blocking.

Káº¿t luáº­n: CSS lÃ  render blocking => Táº£i CSS sá»›m nháº¥t cÃ³ thá»ƒ. Liá»‡u ráº±ng báº¡n cÃ³ Ä‘á»ƒ Ã½ tháº» link css cá»§a báº¡n thÆ°á»ng Ä‘áº·t á»Ÿ Ä‘áº§u khÃ´ng? CÃ³ nguyÃªn nhÃ¢n Ä‘Ã³ ğŸ˜

![Parse CSS](./parse-css.webp)

### Káº¿t há»£p DOM vÃ  CSSOM cáº¥u táº¡o nÃªn render tree

### Events
#### DOMContentLoaded Events
Sá»± kiá»‡n nÃ y bÃ¡o hiá»‡u ta cÃ³ thá»ƒ truy cáº­p Ä‘áº¿n thÃ nh pháº§n cá»§a DOM tree 1 cÃ¡ch an toÃ n. Má»™t sá»‘ script cáº§n thao tÃ¡c vá»›i DOM sáº½ cáº§n láº¯ng nghe sá»± kiá»‡n nÃ y Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p 1 cÃ¡ch an toÃ n. DOMContentLoaded sáº½ nhanh chÃ³ng Ä‘Æ°á»£c trigger
``` javascript
document.addEventListener("DOMContentLoaded", function(){
    // DOM Ä‘Ã£ hoÃ n thÃ nh báº¡n cÃ³ thá»ƒ truy cáº­p vÃ  thao tÃ¡c trÃªn DOM
});
```
#### Load Events

``` javascript
window.addEventListener( "load", function(e) {
  console.log( "Trang web Ä‘Ã£ Ä‘Æ°á»£c táº£i vá» Ä‘áº§y Ä‘á»§. " );
});
```

Sá»± kiá»‡n nÃ y xuáº¥t hiá»‡n khi toÃ n bá»™ stylesheet vÃ  files Ä‘Ã£ Ä‘Æ°á»£c táº£i xuá»‘ng vÃ  trang web Ä‘Ã£ Ä‘Æ°á»£c render hoÃ n toÃ n.

![Javascript](./javascript-exec.png)

### TÃ­nh toÃ¡n bá»‘ cá»¥c vÃ  káº¿t xuáº¥t giao diá»‡n
Khi ta Ä‘Ã£ cÃ³ DOM tree vÃ  CSSOM tree chÃºng sáº½ káº¿t há»£p Ä‘á»ƒ táº¡o thÃ nh Render tree. Render tree chá»©a cÃ¡c pháº§n tá»­ cáº§n Ä‘Æ°á»£c hiá»ƒn thá»‹ trÃªn trang web, nÃ³ sáº½ bá» qua cÃ¡c pháº§n tá»­ khÃ´ng cáº§n thiáº¿t nhÆ° display: none, script, ... <br/>
Render tree cho chÃºng ta biáº¿t cÃ¡ch hiá»ƒn thá»‹ trÃªn trang web.
![Render tree](./render-tree.png)

Browser sáº½ táº¡o ra bá»‘ cá»¥c cá»§a tá»«ng Render tree node bao gá»“m tÃ­nh toÃ¡n size, position, margin, padding, ... => Gá»i lÃ  quÃ¡ trÃ¬nh layout

Browser xÃ¡c Ä‘inh thá»© tá»± váº½ cÃ¡c node cá»§a render tree => Gá»i lÃ  quÃ¡ trÃ¬nh paint

Khi cÃ³ sá»± thay Ä‘á»•i vá» máº·t bá»‘ cá»¥c trang web, cÃ¡c node thay Ä‘á»•i vá» kÃ­ch thÆ°á»›c, vá»‹ trÃ­ => QuÃ¡ trÃ¬nh reflow

Khi cÃ¡c node cÃ³ sá»± thay Ä‘á»•i vá» thuá»™c tÃ­nh mÃ u sáº¯c , ... nhÆ°ng khÃ´ng thay Ä‘á»•i vá» máº·t bá»‘ cá»¥c => QuÃ¡ trÃ¬nh repaint

ChÃºng ta cáº§n quan tÃ¢m Ä‘áº¿n cÃ¡c quÃ¡ trÃ¬nh nÃ y Ä‘á»ƒ tá»‘i Æ°u performance. Sáº½ Ä‘Æ°á»£c phÃ¢n tÃ­ch á»Ÿ nhá»¯ng bÃ i viáº¿t sau.

![Paint](./paint.png)

### Káº¿t luáº­n
QuÃ¡ trÃ¬nh render 1 trang web lÃ  má»™t quÃ¡ trÃ¬nh phá»©c táº¡p mÃ  má»—i láº­p trÃ¬nh viÃªn web nÃªn biáº¿t vÃ  náº¯m Ä‘Æ°á»£c. Hiá»ƒu Ä‘Æ°á»£c cÆ¡ cháº¿ cá»§a browser khi render 1 trang web giÃºp láº­p trÃ¬nh viÃªn cÃ³ thá»ƒ nháº­n biáº¿t Ä‘Æ°á»£c nhá»¯ng váº¥n Ä‘á» vÃ  giáº£i quyáº¿t nhá»¯ng váº¥n Ä‘á» liÃªn quan tá»›i hiá»‡u suáº¥t cá»§a trang web.<br />

Quan trá»ng hÆ¡n quÃ¡ trÃ¬nh xÃ¢y dá»±ng tá»« nhá»¯ng ná»n táº£ng luÃ´n giÃºp chÃºng ta cÃ³ thá»ƒ thÃ­ch nghi trong mÃ´i trÆ°á»ng luÃ´n cÃ³ sá»± thay Ä‘á»•i. 

### TÃ i liá»‡u tham kháº£o

https://dev.to/starkiedev/how-the-browser-renders-a-web-page-1ahc
https://www.explainthis.io/en/swe/fe-script-async-defer-difference